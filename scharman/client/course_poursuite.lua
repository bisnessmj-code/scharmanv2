-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó
-- ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë
-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë
-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù
-- CLIENT - MODE COURSE POURSUITE (CORRIG√â)
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- VARIABLES LOCALES
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

local inGame = false
local currentVehicle = nil
local instanceId = nil
local blockExitThread = nil
local zoneCheckThread = nil
local gameEndTime = nil
local botPed = nil
local botVehicle = nil

-- ‚úÖ NOUVELLES VARIABLES - ZONE DE GUERRE
local canExitVehicle = false           -- Autoris√© √† sortir apr√®s 30s
local warZoneActive = false            -- Zone de guerre cr√©√©e
local warZonePosition = nil            -- Position de la zone de guerre
local warZoneBlip = nil                -- Blip sur la map
local warZoneThread = nil              -- Thread de rendu de la zone
local gameStartTime = nil              -- Temps de d√©but du jeu

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- FONCTIONS UTILITAIRES
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- Afficher une notification NUI personnalis√©e
local function ShowGameNotification(message, duration, notifType)
    SendNUIMessage({
        action = 'showNotification',
        data = {
            message = message,
            duration = duration or Config.CoursePoursuit.MessageDuration,
            type = notifType or 'info'
        }
    })
end

-- Charger un mod√®le avec timeout
local function LoadModel(model)
    local modelHash = GetHashKey(model)
    
    if not IsModelValid(modelHash) then
        Config.ErrorPrint('Mod√®le invalide: ' .. model)
        return false
    end
    
    Config.DebugPrint('Demande de chargement du mod√®le: ' .. model)
    RequestModel(modelHash)
    
    local timeout = 0
    while not HasModelLoaded(modelHash) do
        Wait(100)
        timeout = timeout + 100
        
        if timeout >= 10000 then
            Config.ErrorPrint('Timeout lors du chargement du mod√®le: ' .. model)
            return false
        end
    end
    
    Config.SuccessPrint('Mod√®le charg√©: ' .. model)
    return true
end

-- Placer le joueur dans un v√©hicule de mani√®re robuste
local function ForcePlayerIntoVehicle(ped, vehicle, seat)
    Config.DebugPrint('Tentative de placement du joueur dans le v√©hicule...')
    
    -- V√©rifications de base
    if not DoesEntityExist(vehicle) then
        Config.ErrorPrint('Le v√©hicule n\'existe pas!')
        return false
    end
    
    if not DoesEntityExist(ped) then
        Config.ErrorPrint('Le PED n\'existe pas!')
        return false
    end
    
    -- S'assurer que le v√©hicule est au sol
    SetVehicleOnGroundProperly(vehicle)
    Wait(100)
    
    Config.DebugPrint('√âtat avant placement:')
    Config.DebugPrint('- V√©hicule existe: ' .. tostring(DoesEntityExist(vehicle)))
    Config.DebugPrint('- PED existe: ' .. tostring(DoesEntityExist(ped)))
    Config.DebugPrint('- Si√®ge: ' .. tostring(seat))
    
    -- M√©thode 1: TaskWarpPedIntoVehicle
    TaskWarpPedIntoVehicle(ped, vehicle, seat)
    Wait(500)
    
    -- V√©rifier si le joueur est dans le v√©hicule
    local attempts = 0
    local maxAttempts = 10
    
    while GetVehiclePedIsIn(ped, false) ~= vehicle and attempts < maxAttempts do
        attempts = attempts + 1
        Config.DebugPrint('Tentative ' .. attempts .. '/' .. maxAttempts .. ' de placement...')
        
        -- R√©essayer avec TaskWarpPedIntoVehicle
        TaskWarpPedIntoVehicle(ped, vehicle, seat)
        Wait(300)
        
        -- Si √ßa ne marche toujours pas, essayer SetPedIntoVehicle
        if GetVehiclePedIsIn(ped, false) ~= vehicle then
            Config.DebugPrint('TaskWarp √©chou√©, essai avec SetPedIntoVehicle...')
            SetPedIntoVehicle(ped, vehicle, seat)
            Wait(300)
        end
    end
    
    -- V√©rification finale
    local currentVeh = GetVehiclePedIsIn(ped, false)
    local isInVehicle = currentVeh == vehicle
    
    Config.DebugPrint('√âtat apr√®s placement:')
    Config.DebugPrint('- V√©hicule actuel: ' .. tostring(currentVeh))
    Config.DebugPrint('- V√©hicule cible: ' .. tostring(vehicle))
    Config.DebugPrint('- Dans le v√©hicule: ' .. tostring(isInVehicle))
    Config.DebugPrint('- Tentatives: ' .. attempts)
    
    if isInVehicle then
        Config.SuccessPrint('Joueur plac√© dans le v√©hicule avec succ√®s!')
        return true
    else
        Config.ErrorPrint('√âCHEC: Le joueur n\'est pas dans le v√©hicule apr√®s ' .. attempts .. ' tentatives')
        return false
    end
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- FONCTIONS BOT ADVERSAIRE
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- Supprimer le bot
local function DeleteBot()
    Config.DebugPrint('Suppression du bot...')
    
    if DoesEntityExist(botVehicle) then
        DeleteEntity(botVehicle)
        botVehicle = nil
        Config.DebugPrint('V√©hicule bot supprim√©')
    end
    
    if DoesEntityExist(botPed) then
        DeleteEntity(botPed)
        botPed = nil
        Config.DebugPrint('Bot supprim√©')
    end
    
    Config.SuccessPrint('Bot nettoy√©')
end

-- Spawner un bot adversaire
local function SpawnBotAdversary()
    if not Config.CoursePoursuit.SpawnBotInSolo then
        Config.DebugPrint('Spawn bot d√©sactiv√© dans la config')
        return false
    end
    
    Config.InfoPrint('‚ïê‚ïê‚ïê D√âBUT SPAWN BOT ‚ïê‚ïê‚ïê')
    
    local ped = PlayerPedId()
    local playerCoords = GetEntityCoords(ped)
    local playerHeading = GetEntityHeading(ped)
    
    Config.DebugPrint('Position joueur: ' .. tostring(playerCoords))
    Config.DebugPrint('Heading joueur: ' .. tostring(playerHeading))
    
    -- Calculer la position du bot (√† c√¥t√© du joueur)
    local offset = Config.CoursePoursuit.BotSpawnOffset
    local forwardX = math.cos(math.rad(playerHeading))
    local forwardY = math.sin(math.rad(playerHeading))
    
    local botCoords = vector3(
        playerCoords.x + (forwardX * offset.x) + offset.y,
        playerCoords.y + (forwardY * offset.x),
        playerCoords.z + offset.z
    )
    
    Config.DebugPrint('Position bot calcul√©e: ' .. tostring(botCoords))
    
    -- Charger le mod√®le du bot
    if not LoadModel(Config.CoursePoursuit.BotModel) then
        Config.ErrorPrint('√âchec chargement mod√®le bot')
        return false
    end
    
    -- Cr√©er le bot
    Config.DebugPrint('Cr√©ation du PED bot...')
    botPed = CreatePed(4, GetHashKey(Config.CoursePoursuit.BotModel), botCoords.x, botCoords.y, botCoords.z, playerHeading, true, true)  -- ‚úÖ CORRECTION: true, true pour forcer cr√©ation r√©seau
    
    -- Attendre synchronisation
    Wait(300)
    
    if not DoesEntityExist(botPed) then
        Config.ErrorPrint('√âchec cr√©ation bot')
        SetModelAsNoLongerNeeded(GetHashKey(Config.CoursePoursuit.BotModel))
        return false
    end
    
    Config.SuccessPrint('Bot cr√©√©: ' .. botPed)
    Config.DebugPrint('Bot existe: ' .. tostring(DoesEntityExist(botPed)))
    
    -- Rendre le bot invincible
    SetEntityInvincible(botPed, true)
    SetBlockingOfNonTemporaryEvents(botPed, true)
    
    -- Charger le mod√®le du v√©hicule bot
    if not LoadModel(Config.CoursePoursuit.BotVehicle) then
        Config.ErrorPrint('√âchec chargement v√©hicule bot')
        DeleteEntity(botPed)
        botPed = nil
        return false
    end
    
    -- Cr√©er le v√©hicule du bot
    Config.DebugPrint('Cr√©ation du v√©hicule bot...')
    botVehicle = CreateVehicle(
        GetHashKey(Config.CoursePoursuit.BotVehicle),
        botCoords.x,
        botCoords.y,
        botCoords.z,
        playerHeading,
        true,
        true  -- ‚úÖ CORRECTION: true pour forcer la cr√©ation r√©seau
    )
    
    -- Attendre synchronisation
    Wait(500)
    
    if not DoesEntityExist(botVehicle) then
        Config.ErrorPrint('√âchec cr√©ation v√©hicule bot')
        DeleteEntity(botPed)
        botPed = nil
        SetModelAsNoLongerNeeded(GetHashKey(Config.CoursePoursuit.BotVehicle))
        return false
    end
    
    Config.SuccessPrint('V√©hicule bot cr√©√©: ' .. botVehicle)
    Config.DebugPrint('V√©hicule bot existe: ' .. tostring(DoesEntityExist(botVehicle)))
    
    -- Personnaliser le v√©hicule bot
    local botColor = Config.CoursePoursuit.BotVehicleColor
    SetVehicleCustomPrimaryColour(botVehicle, botColor.primary.r, botColor.primary.g, botColor.primary.b)
    SetVehicleCustomSecondaryColour(botVehicle, botColor.secondary.r, botColor.secondary.g, botColor.secondary.b)
    SetVehicleNumberPlateText(botVehicle, 'BOT~AI')
    
    -- V√©rifier apr√®s personnalisation
    if not DoesEntityExist(botVehicle) then
        Config.ErrorPrint('V√©hicule bot disparu apr√®s personnalisation')
        DeleteEntity(botPed)
        botPed = nil
        return false
    end
    
    -- Rendre le v√©hicule plus r√©sistant
    SetVehicleEngineHealth(botVehicle, 1000.0)
    SetVehicleBodyHealth(botVehicle, 1000.0)
    SetVehicleOnGroundProperly(botVehicle)
    
    Config.DebugPrint('V√©hicule bot personnalis√©')
    
    -- Attendre que le v√©hicule soit bien charg√©
    Wait(1000)  -- ‚úÖ CORRECTION: Wait augment√© de 500 √† 1000
    
    -- V√©rification finale
    if not DoesEntityExist(botVehicle) then
        Config.ErrorPrint('V√©hicule bot disparu avant placement')
        DeleteEntity(botPed)
        botPed = nil
        return false
    end
    
    -- Mettre le bot dans le v√©hicule (si√®ge conducteur = -1)
    Config.DebugPrint('Placement du bot dans le v√©hicule...')
    
    TaskWarpPedIntoVehicle(botPed, botVehicle, -1)
    Wait(1000)
    
    -- V√©rifier que le bot est dans le v√©hicule
    local attempts = 0
    local maxAttempts = 5
    
    while GetVehiclePedIsIn(botPed, false) ~= botVehicle and attempts < maxAttempts do
        attempts = attempts + 1
        Config.DebugPrint('Tentative ' .. attempts .. ' de placement du bot...')
        TaskWarpPedIntoVehicle(botPed, botVehicle, -1)
        Wait(500)
        
        if GetVehiclePedIsIn(botPed, false) ~= botVehicle then
            SetPedIntoVehicle(botPed, botVehicle, -1)
            Wait(500)
        end
    end
    
    local botInVehicle = GetVehiclePedIsIn(botPed, false) == botVehicle
    
    Config.DebugPrint('Bot dans v√©hicule: ' .. tostring(botInVehicle))
    
    if not botInVehicle then
        Config.ErrorPrint('√âCHEC: Bot pas dans le v√©hicule!')
        DeleteBot()
        return false
    end
    
    -- Faire conduire le bot
    Config.DebugPrint('Configuration de la conduite du bot...')
    
    if Config.CoursePoursuit.BotRandomRoute then
        TaskVehicleDriveWander(
            botPed,
            botVehicle,
            Config.CoursePoursuit.BotSpeed,
            Config.CoursePoursuit.BotDrivingStyle
        )
        Config.DebugPrint('Bot en conduite al√©atoire')
    else
        -- Conduire vers un point lointain
        local targetCoords = vector3(
            botCoords.x + 500.0,
            botCoords.y + 500.0,
            botCoords.z
        )
        TaskVehicleDriveToCoordLongrange(
            botPed,
            botVehicle,
            targetCoords.x,
            targetCoords.y,
            targetCoords.z,
            Config.CoursePoursuit.BotSpeed,
            Config.CoursePoursuit.BotDrivingStyle,
            10.0
        )
        Config.DebugPrint('Bot en conduite vers point pr√©cis')
    end
    
    -- Lib√©rer les mod√®les
    SetModelAsNoLongerNeeded(GetHashKey(Config.CoursePoursuit.BotModel))
    SetModelAsNoLongerNeeded(GetHashKey(Config.CoursePoursuit.BotVehicle))
    
    Config.InfoPrint('‚ïê‚ïê‚ïê FIN SPAWN BOT - SUCC√àS ‚ïê‚ïê‚ïê')
    Config.SuccessPrint('Bot adversaire spawn√© et en conduite!')
    ShowGameNotification('ü§ñ Un adversaire bot est apparu !', 4000, 'success')
    
    return true
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- D√âMARRAGE DU JEU
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- D√©marrer le jeu
local function StartCoursePoursuiteGame(data)
    if inGame then
        Config.DebugPrint('D√©j√† en jeu')
        return
    end
    
    Config.InfoPrint('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
    Config.InfoPrint('D√âMARRAGE DE LA COURSE POURSUITE')
    Config.InfoPrint('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
    
    -- Protection contre √©cran noir avec pcall
    local success, err = pcall(function()
        local ped = PlayerPedId()
        instanceId = data.instanceId
        
        Config.DebugPrint('Instance ID: ' .. tostring(instanceId))
        Config.DebugPrint('PED ID: ' .. tostring(ped))
        
        -- R√©cup√©rer les coordonn√©es et le mod√®le
        local spawnCoords = data.spawnCoords or Config.CoursePoursuit.SpawnCoords
        local vehicleModel = data.vehicleModel or Config.CoursePoursuit.VehicleModel
        
        Config.DebugPrint('Spawn coords: ' .. tostring(spawnCoords))
        Config.DebugPrint('Vehicle model: ' .. vehicleModel)
        
        -- Notification de t√©l√©portation
        ShowGameNotification(Config.CoursePoursuit.Notifications.teleporting, 2000, 'info')
        
        -- Fade out
        Config.DebugPrint('Fade out...')
        DoScreenFadeOut(800)
        while not IsScreenFadedOut() do
            Wait(10)
        end
        Config.DebugPrint('√âcran noir')
        
        -- T√©l√©porter le joueur
        Config.DebugPrint('T√©l√©portation du joueur...')
        SetEntityCoords(ped, spawnCoords.x, spawnCoords.y, spawnCoords.z, false, false, false, true)
        SetEntityHeading(ped, spawnCoords.w)
        Config.DebugPrint('Joueur t√©l√©port√©')
        
        -- ‚úÖ CORRECTION V4: Attendre synchronisation du routing bucket
        -- Note: GetPlayerRoutingBucket() n'existe pas c√¥t√© client
        -- On attend simplement un d√©lai suffisant pour la synchronisation r√©seau
        local expectedBucket = data.bucketId
        if expectedBucket then
            Config.InfoPrint('Synchronisation routing bucket ' .. expectedBucket .. ' en cours...')
            Config.DebugPrint('Attente de 3 secondes pour synchronisation r√©seau...')
            
            -- Attendre 3 secondes pour laisser le temps au serveur de synchroniser le bucket
            Wait(3000)
            
            Config.SuccessPrint('D√©lai de synchronisation termin√©')
        else
            -- Pas de bucket fourni, attendre quand m√™me
            Config.DebugPrint('Pas de bucket ID fourni, attente 3 secondes...')
            Wait(3000)
        end
        
        -- Attendre stabilisation suppl√©mentaire
        Wait(1000)
        
        -- ‚úÖ V5: R√©cup√©rer le v√©hicule cr√©√© par le serveur via Network ID
        local vehicleNetId = data.vehicleNetId
        
        if vehicleNetId then
            Config.InfoPrint('‚ïê‚ïê‚ïê R√âCUP√âRATION V√âHICULE SERVEUR (V5) ‚ïê‚ïê‚ïê')
            Config.DebugPrint('Vehicle Network ID re√ßu: ' .. vehicleNetId)
            
            -- Attendre que le v√©hicule r√©seau soit synchronis√©
            local maxAttempts = 100  -- 10 secondes max
            local attempt = 0
            
            repeat
                currentVehicle = NetworkGetEntityFromNetworkId(vehicleNetId)
                
                if currentVehicle and DoesEntityExist(currentVehicle) then
                    Config.SuccessPrint('V√©hicule r√©cup√©r√© avec succ√®s: ' .. currentVehicle)
                    break
                end
                
                attempt = attempt + 1
                Wait(100)
                
                if attempt % 10 == 0 then
                    Config.DebugPrint('Attente v√©hicule r√©seau... Tentative ' .. attempt .. '/100')
                end
            until attempt >= maxAttempts
            
            if not currentVehicle or not DoesEntityExist(currentVehicle) then
                error('√âchec r√©cup√©ration v√©hicule r√©seau apr√®s ' .. (maxAttempts * 100) .. 'ms - NetID: ' .. vehicleNetId)
            end
            
            Config.DebugPrint('V√©hicule existe: ' .. tostring(DoesEntityExist(currentVehicle)))
            Config.DebugPrint('V√©hicule handle: ' .. currentVehicle)
            
            -- S'assurer que le v√©hicule est au sol
            SetVehicleOnGroundProperly(currentVehicle)
            Wait(500)
            
        else
            -- ‚ùå FALLBACK: Cr√©er le v√©hicule c√¥t√© client (ancien syst√®me)
            Config.ErrorPrint('ATTENTION: Pas de Network ID re√ßu, utilisation ancien syst√®me')
            
            -- Charger le mod√®le du v√©hicule
            Config.DebugPrint('Chargement du mod√®le de v√©hicule...')
            if not LoadModel(vehicleModel) then
                error('√âchec du chargement du mod√®le de v√©hicule: ' .. vehicleModel)
            end
            
            -- Cr√©er le v√©hicule
            Config.DebugPrint('Cr√©ation du v√©hicule joueur...')
            currentVehicle = CreateVehicle(
                GetHashKey(vehicleModel),
                spawnCoords.x,
                spawnCoords.y,
                spawnCoords.z,
                spawnCoords.w,
                true,
                true
            )
            
            Config.DebugPrint('V√©hicule handle: ' .. tostring(currentVehicle))
            
            -- Attendre que le v√©hicule soit synchronis√©
            Config.DebugPrint('Attente synchronisation v√©hicule...')
            Wait(1500)
            
            -- V√©rifier existence
            Config.DebugPrint('V√©rification existence v√©hicule...')
            if not DoesEntityExist(currentVehicle) then
                error('√âchec de la cr√©ation du v√©hicule - Handle: ' .. tostring(currentVehicle) .. ' - DoesEntityExist: false')
            end
            
            Config.SuccessPrint('V√©hicule cr√©√©: ' .. currentVehicle)
            Config.DebugPrint('V√©hicule existe apr√®s cr√©ation: ' .. tostring(DoesEntityExist(currentVehicle)))
            
            -- S'assurer que le v√©hicule est au sol
            SetVehicleOnGroundProperly(currentVehicle)
            Wait(500)
            
            -- V√©rifier que le v√©hicule existe toujours
            if not DoesEntityExist(currentVehicle) then
                error('Le v√©hicule a disparu apr√®s SetVehicleOnGroundProperly')
            end
            Config.DebugPrint('V√©hicule existe apr√®s ground properly: true')
        end
        
        -- ‚úÖ V5: Personnaliser le v√©hicule SEULEMENT si cr√©√© c√¥t√© client (fallback)
        if not vehicleNetId then
            -- V√©hicule cr√©√© c√¥t√© client, on le personnalise
            Config.DebugPrint('Personnalisation du v√©hicule (client-side)...')
            
            -- V√©rifier l'existence avant chaque op√©ration
            if not DoesEntityExist(currentVehicle) then
                error('Le v√©hicule a disparu avant la personnalisation')
            end
            
            local primaryColor = Config.CoursePoursuit.VehicleCustomization.primaryColor
            local secondaryColor = Config.CoursePoursuit.VehicleCustomization.secondaryColor
            SetVehicleCustomPrimaryColour(currentVehicle, primaryColor.r, primaryColor.g, primaryColor.b)
            SetVehicleCustomSecondaryColour(currentVehicle, secondaryColor.r, secondaryColor.g, secondaryColor.b)
            
            -- V√©rifier apr√®s couleurs
            if not DoesEntityExist(currentVehicle) then
                error('Le v√©hicule a disparu apr√®s les couleurs')
            end
            Config.DebugPrint('Couleurs appliqu√©es')
            
            -- Appliquer les mods
            local mods = Config.CoursePoursuit.VehicleCustomization.mods
            SetVehicleMod(currentVehicle, 11, mods.engine, false)
            SetVehicleMod(currentVehicle, 12, mods.brakes, false)
            SetVehicleMod(currentVehicle, 13, mods.transmission, false)
            SetVehicleMod(currentVehicle, 15, mods.suspension, false)
            ToggleVehicleMod(currentVehicle, 18, mods.turbo)
            
            -- V√©rifier apr√®s mods
            if not DoesEntityExist(currentVehicle) then
                error('Le v√©hicule a disparu apr√®s les mods')
            end
            Config.DebugPrint('Mods appliqu√©s')
            
            -- Plaque d'immatriculation
            SetVehicleNumberPlateText(currentVehicle, 'COURSE')
            
            -- Remplir essence (avec protection)
            local success, err = pcall(function()
                SetVehicleFuelLevel(currentVehicle, 100.0)
            end)
            if not success then
                Config.DebugPrint('SetVehicleFuelLevel √©chou√© (normal si pas de script fuel): ' .. tostring(err))
            end
            
            -- V√©rifier apr√®s essence
            if not DoesEntityExist(currentVehicle) then
                error('Le v√©hicule a disparu apr√®s SetVehicleFuelLevel')
            end
            Config.DebugPrint('Essence configur√©e')
            
            -- Sant√© du v√©hicule
            SetVehicleEngineHealth(currentVehicle, 1000.0)
            SetVehicleBodyHealth(currentVehicle, 1000.0)
            
            -- V√©rifier apr√®s sant√©
            if not DoesEntityExist(currentVehicle) then
                error('Le v√©hicule a disparu apr√®s sant√©')
            end
            Config.DebugPrint('Sant√© configur√©e')
            
            -- Verrouiller les portes
            SetVehicleDoorsLocked(currentVehicle, 2)
            SetVehicleDoorsLockedForAllPlayers(currentVehicle, true)
            
            -- V√©rification finale
            if not DoesEntityExist(currentVehicle) then
                error('Le v√©hicule a disparu apr√®s verrouillage')
            end
            
            Config.DebugPrint('V√©hicule personnalis√© - Existe: ' .. tostring(DoesEntityExist(currentVehicle)))
            
            -- Attendre que le v√©hicule soit stable
            Wait(1000)
            
            -- V√©rification finale avant placement
            if not DoesEntityExist(currentVehicle) then
                error('Le v√©hicule a disparu avant le placement du joueur')
            end
            Config.DebugPrint('V√©hicule stable et pr√™t pour placement')
        else
            -- V√©hicule cr√©√© c√¥t√© serveur, on le personnalise maintenant c√¥t√© client
            Config.InfoPrint('Personnalisation du v√©hicule r√©cup√©r√© du serveur...')
            
            -- V√©rifier existence
            if not DoesEntityExist(currentVehicle) then
                error('Le v√©hicule n\'existe pas avant personnalisation')
            end
            
            -- Couleurs
            local primaryColor = Config.CoursePoursuit.VehicleCustomization.primaryColor
            local secondaryColor = Config.CoursePoursuit.VehicleCustomization.secondaryColor
            SetVehicleCustomPrimaryColour(currentVehicle, primaryColor.r, primaryColor.g, primaryColor.b)
            SetVehicleCustomSecondaryColour(currentVehicle, secondaryColor.r, secondaryColor.g, secondaryColor.b)
            Config.DebugPrint('Couleurs appliqu√©es')
            
            -- Mods
            local mods = Config.CoursePoursuit.VehicleCustomization.mods
            SetVehicleMod(currentVehicle, 11, mods.engine, false)
            SetVehicleMod(currentVehicle, 12, mods.brakes, false)
            SetVehicleMod(currentVehicle, 13, mods.transmission, false)
            SetVehicleMod(currentVehicle, 15, mods.suspension, false)
            ToggleVehicleMod(currentVehicle, 18, mods.turbo)
            Config.DebugPrint('Mods appliqu√©s')
            
            -- Plaque
            SetVehicleNumberPlateText(currentVehicle, 'COURSE')
            
            -- Essence (avec protection)
            local success, err = pcall(function()
                SetVehicleFuelLevel(currentVehicle, 100.0)
            end)
            if not success then
                Config.DebugPrint('SetVehicleFuelLevel √©chou√©: ' .. tostring(err))
            end
            
            -- Sant√©
            SetVehicleEngineHealth(currentVehicle, 1000.0)
            SetVehicleBodyHealth(currentVehicle, 1000.0)
            
            -- Verrouillage
            SetVehicleDoorsLocked(currentVehicle, 2)
            SetVehicleDoorsLockedForAllPlayers(currentVehicle, true)
            
            Config.SuccessPrint('V√©hicule personnalis√© c√¥t√© client')
            
            -- V√©rifier que le v√©hicule existe toujours
            if not DoesEntityExist(currentVehicle) then
                error('Le v√©hicule a disparu apr√®s personnalisation')
            end
        end
        
        Config.DebugPrint('V√©hicule pr√™t pour placement')
        
        -- PLACEMENT DU JOUEUR DANS LE V√âHICULE (robuste)
        Config.InfoPrint('‚ïê‚ïê‚ïê PLACEMENT JOUEUR DANS V√âHICULE ‚ïê‚ïê‚ïê')
        local placementSuccess = ForcePlayerIntoVehicle(ped, currentVehicle, -1)
        
        if not placementSuccess then
            error('√âCHEC CRITIQUE: Impossible de placer le joueur dans le v√©hicule')
        end
        
        -- Lib√©rer le mod√®le
        SetModelAsNoLongerNeeded(GetHashKey(vehicleModel))
        
        -- Fade in
        Config.DebugPrint('Fade in...')
        DoScreenFadeIn(500)
        while not IsScreenFadedIn() do
            Wait(10)
        end
        Config.DebugPrint('√âcran visible')
        
        -- Marquer comme en jeu
        inGame = true
        Config.SuccessPrint('√âtat: EN JEU')
        
        -- Notification de d√©marrage
        ShowGameNotification(Config.CoursePoursuit.Notifications.starting, 3000, 'info')
        Wait(3000)
        ShowGameNotification(Config.CoursePoursuit.Notifications.started, 3000, 'success')
        
        -- ‚úÖ Initialiser le temps de d√©but
        gameStartTime = GetGameTimer()
        
        -- Calculer l'heure de fin si dur√©e d√©finie
        if Config.CoursePoursuit.GameDuration > 0 then
            gameEndTime = GetGameTimer() + (Config.CoursePoursuit.GameDuration * 1000)
            Config.DebugPrint('Dur√©e de jeu: ' .. Config.CoursePoursuit.GameDuration .. 's')
        end
        
        -- Spawner un bot si mode solo activ√©
        if data.spawnBot then
            Config.InfoPrint('Mode solo d√©tect√©, spawn du bot dans 2 secondes...')
            Wait(2000)
            
            local botSpawned = SpawnBotAdversary()
            
            if not botSpawned then
                Config.ErrorPrint('√âchec du spawn du bot, mais la partie continue')
            end
        end
        
        -- D√©marrer les threads de gestion
        StartGameThreads()
        
        Config.InfoPrint('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
        Config.SuccessPrint('COURSE POURSUITE D√âMARR√âE AVEC SUCC√àS!')
        Config.InfoPrint('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
    end)
    
    -- Si erreur, restaurer l'√©cran et nettoyer
    if not success then
        Config.ErrorPrint('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
        Config.ErrorPrint('ERREUR CRITIQUE lors du d√©marrage:')
        Config.ErrorPrint(tostring(err))
        Config.ErrorPrint('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
        
        -- TOUJOURS faire le fade in pour √©viter √©cran noir
        if IsScreenFadedOut() then
            DoScreenFadeIn(500)
        end
        
        -- Nettoyer
        if DoesEntityExist(currentVehicle) then
            DeleteEntity(currentVehicle)
            currentVehicle = nil
        end
        
        DeleteBot()
        
        -- Notification d'erreur
        ShowGameNotification('‚ùå Erreur lors du d√©marrage: ' .. tostring(err), 5000, 'error')
        
        -- Pr√©venir le serveur
        TriggerServerEvent('scharman:server:coursePoursuiteLeft', instanceId)
        
        inGame = false
        instanceId = nil
    end
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- ARR√äT DU JEU
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- Arr√™ter le jeu
local function StopCoursePoursuiteGame()
    if not inGame then
        Config.DebugPrint('Pas en jeu')
        return
    end
    
    Config.InfoPrint('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
    Config.InfoPrint('ARR√äT DU MODE COURSE POURSUITE')
    Config.InfoPrint('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
    
    -- Marquer comme pas en jeu
    inGame = false
    
    -- Arr√™ter les threads
    blockExitThread = nil
    zoneCheckThread = nil
    gameEndTime = nil
    gameStartTime = nil
    warZoneThread = nil
    
    -- ‚úÖ Nettoyer la zone de guerre
    if warZoneBlip then
        RemoveBlip(warZoneBlip)
        warZoneBlip = nil
    end
    canExitVehicle = false
    warZoneActive = false
    warZonePosition = nil
    Config.DebugPrint('Zone de guerre nettoy√©e')
    
    local ped = PlayerPedId()
    
    -- T√©l√©porter le joueur √† la position de retour
    if Config.CoursePoursuit.ReturnToNormalCoords then
        Config.DebugPrint('T√©l√©portation de retour...')
        DoScreenFadeOut(500)
        Wait(500)
        
        local returnCoords = Config.CoursePoursuit.ReturnToNormalCoords
        SetEntityCoords(ped, returnCoords.x, returnCoords.y, returnCoords.z, false, false, false, true)
        SetEntityHeading(ped, returnCoords.w)
        
        Wait(500)
        DoScreenFadeIn(500)
        Config.DebugPrint('Joueur t√©l√©port√© au PED')
    end
    
    -- Supprimer le v√©hicule
    if DoesEntityExist(currentVehicle) then
        DeleteEntity(currentVehicle)
        currentVehicle = nil
        Config.DebugPrint('V√©hicule joueur supprim√©')
    end
    
    -- Supprimer le bot
    DeleteBot()
    
    -- R√©initialiser instanceId
    instanceId = nil
    
    Config.InfoPrint('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
    Config.SuccessPrint('NETTOYAGE TERMIN√â')
    Config.InfoPrint('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- THREADS DE GESTION
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- ZONE DE GUERRE
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- Cr√©er le blip de la zone de guerre sur la map
local function CreateWarZoneBlip()
    if warZoneBlip then
        RemoveBlip(warZoneBlip)
    end
    
    warZoneBlip = AddBlipForRadius(warZonePosition.x, warZonePosition.y, warZonePosition.z, 50.0)
    SetBlipHighDetail(warZoneBlip, true)
    SetBlipColour(warZoneBlip, 1) -- Rouge
    SetBlipAlpha(warZoneBlip, 128) -- Semi-transparent
    
    -- Ajouter un blip point au centre
    local centerBlip = AddBlipForCoord(warZonePosition.x, warZonePosition.y, warZonePosition.z)
    SetBlipSprite(centerBlip, 84) -- Ic√¥ne cr√¢ne
    SetBlipDisplay(centerBlip, 4)
    SetBlipScale(centerBlip, 1.2)
    SetBlipColour(centerBlip, 1) -- Rouge
    SetBlipAsShortRange(centerBlip, false)
    BeginTextCommandSetBlipName("STRING")
    AddTextComponentString("üî¥ ZONE DE GUERRE")
    EndTextCommandSetBlipName(centerBlip)
    
    Config.SuccessPrint('Blip zone de guerre cr√©√©')
end

-- Thread de rendu de la zone de guerre (colonne de lumi√®re)
local function StartWarZoneThread()
    if warZoneThread then return end
    
    Config.InfoPrint('Thread de rendu zone de guerre d√©marr√©')
    
    warZoneThread = CreateThread(function()
        while inGame and warZoneActive and warZonePosition do
            Wait(0)
            
            local pos = warZonePosition
            
            -- Dessiner la colonne de lumi√®re rouge (cylinder marker)
            -- Type 28 = Cylindre vertical
            DrawMarker(
                28,                          -- Type : Cylindre vertical invers√© (colonne)
                pos.x, pos.y, pos.z,        -- Position
                0.0, 0.0, 0.0,              -- Direction
                0.0, 0.0, 0.0,              -- Rotation
                50.0, 50.0, 150.0,          -- Scale (rayon 50m, hauteur 150m)
                255, 0, 0, 100,             -- Couleur RGBA (rouge semi-transparent)
                false,                       -- Bob up and down
                false,                       -- Face camera
                2,                           -- Rotation
                false,                       -- Rotate
                nil, nil,                   -- Texture
                false                        -- Project
            )
            
            -- Dessiner un cercle au sol (rayon 50m)
            DrawMarker(
                1,                           -- Type : Cylindre au sol
                pos.x, pos.y, pos.z - 1.0,  -- Position (l√©g√®rement sous le sol)
                0.0, 0.0, 0.0,              -- Direction
                0.0, 0.0, 0.0,              -- Rotation
                100.0, 100.0, 1.0,          -- Scale (diam√®tre 100m = rayon 50m)
                255, 0, 0, 150,             -- Couleur RGBA (rouge)
                false,                       -- Bob
                false,                       -- Face camera
                2,                           -- Rotation
                false,                       -- Rotate
                nil, nil,                   -- Texture
                false                        -- Project
            )
        end
        
        warZoneThread = nil
        Config.DebugPrint('Thread de rendu zone de guerre arr√™t√©')
    end)
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- THREADS DE GESTION
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- Thread de blocage de sortie du v√©hicule
local function StartBlockExitThread()
    if blockExitThread then return end
    
    Config.DebugPrint('Thread de blocage de sortie d√©marr√©')
    
    -- D√©marrer le timer de 30 secondes
    CreateThread(function()
        Wait(30000) -- 30 secondes
        canExitVehicle = true
        Config.SuccessPrint('‚úÖ Vous pouvez maintenant sortir du v√©hicule !')
        ShowGameNotification('‚úÖ Vous pouvez maintenant sortir du v√©hicule !', 5000, 'success')
    end)
    
    blockExitThread = CreateThread(function()
        local wasInVehicle = true
        
        while inGame and Config.CoursePoursuit.BlockExitVehicle do
            Wait(0)
            
            local ped = PlayerPedId()
            local isInVehicle = IsPedInVehicle(ped, currentVehicle, false)
            
            -- Si pas encore autoris√© √† sortir
            if not canExitVehicle then
                -- Bloquer la touche F (sortir du v√©hicule)
                DisableControlAction(0, 75, true) -- INPUT_VEH_EXIT
                
                -- Si le joueur essaye de sortir
                if IsDisabledControlJustPressed(0, 75) then
                    local timeElapsed = (GetGameTimer() - gameStartTime) / 1000
                    local timeLeft = math.max(0, 30 - timeElapsed)
                    ShowGameNotification(string.format('‚è∞ Attendez encore %d secondes avant de pouvoir sortir !', math.ceil(timeLeft)), 3000, 'warning')
                    Config.DebugPrint('Tentative de sortie bloqu√©e (trop t√¥t)')
                end
                
                -- Si le joueur est sorti (par un bug), le remettre dans le v√©hicule
                if DoesEntityExist(currentVehicle) and not isInVehicle then
                    Config.DebugPrint('Joueur sorti du v√©hicule avant 30s, replacement forc√©!')
                    ForcePlayerIntoVehicle(ped, currentVehicle, -1)
                    ShowGameNotification('üöó Retour forc√© dans le v√©hicule ! Attendez 30 secondes.', 3000, 'warning')
                end
            else
                -- Apr√®s 30s, autoriser la sortie mais d√©tecter quand le joueur sort
                if wasInVehicle and not isInVehicle and not warZoneActive then
                    -- Le joueur vient de sortir du v√©hicule !
                    local playerCoords = GetEntityCoords(ped)
                    warZonePosition = playerCoords
                    warZoneActive = true
                    
                    Config.SuccessPrint('üî¥ ZONE DE GUERRE CR√â√âE √Ä VOTRE POSITION !')
                    ShowGameNotification('üî¥ ZONE DE GUERRE cr√©√©e √† votre position !', 5000, 'error')
                    
                    -- Cr√©er le blip sur la map
                    CreateWarZoneBlip()
                    
                    -- D√©marrer le thread de rendu de la zone
                    StartWarZoneThread()
                end
            end
            
            wasInVehicle = isInVehicle
        end
        
        blockExitThread = nil
        Config.DebugPrint('Thread de blocage de sortie arr√™t√©')
    end)
end

-- Thread de v√©rification de zone
local function StartZoneCheckThread()
    if not Config.CoursePoursuit.UseZoneLimit then return end
    if zoneCheckThread then return end
    
    Config.DebugPrint('Thread de v√©rification de zone d√©marr√©')
    
    zoneCheckThread = CreateThread(function()
        local timeOutOfZone = 0
        
        while inGame do
            Wait(1000) -- V√©rifier chaque seconde
            
            local ped = PlayerPedId()
            local playerCoords = GetEntityCoords(ped)
            local zoneCenter = Config.CoursePoursuit.SpawnCoords
            local distance = #(playerCoords - vector3(zoneCenter.x, zoneCenter.y, zoneCenter.z))
            
            if distance > Config.CoursePoursuit.ZoneRadius then
                timeOutOfZone = timeOutOfZone + 1
                
                if timeOutOfZone == 1 then
                    ShowGameNotification('‚ö†Ô∏è Retournez dans la zone de jeu !', 3000, 'warning')
                end
                
                if timeOutOfZone >= Config.CoursePoursuit.OutOfZoneTimeout then
                    ShowGameNotification('üö´ Trop loin de la zone ! T√©l√©portation...', 3000, 'error')
                    
                    -- T√©l√©porter dans la zone
                    SetEntityCoords(ped, zoneCenter.x, zoneCenter.y, zoneCenter.z, false, false, false, true)
                    timeOutOfZone = 0
                end
            else
                timeOutOfZone = 0
            end
        end
        
        zoneCheckThread = nil
        Config.DebugPrint('Thread de v√©rification de zone arr√™t√©')
    end)
end

-- Thread du timer de jeu
local function StartGameTimerThread()
    if Config.CoursePoursuit.GameDuration <= 0 then return end
    
    Config.DebugPrint('Thread timer de jeu d√©marr√©')
    
    CreateThread(function()
        while inGame and gameEndTime do
            Wait(1000) -- V√©rifier chaque seconde
            
            -- V√©rifier que gameEndTime existe toujours (peut √™tre nil apr√®s StopCoursePoursuiteGame)
            if not gameEndTime then
                break
            end
            
            local timeLeft = gameEndTime - GetGameTimer()
            
            if timeLeft <= 0 then
                ShowGameNotification('‚è±Ô∏è Temps √©coul√© ! Fin de la partie.', 5000, 'info')
                StopCoursePoursuiteGame()
                TriggerServerEvent('scharman:server:coursePoursuiteLeft', instanceId)
                break
            end
        end
        
        Config.DebugPrint('Thread timer de jeu arr√™t√©')
    end)
end

-- D√©marrer tous les threads
function StartGameThreads()
    Config.DebugPrint('D√©marrage des threads de gestion...')
    StartBlockExitThread()
    StartZoneCheckThread()
    StartGameTimerThread()
    Config.DebugPrint('Threads d√©marr√©s')
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- √âV√âNEMENTS
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- D√©marrer le jeu
RegisterNetEvent('scharman:client:startCoursePoursuit', function(data)
    Config.DebugPrint('√âv√©nement startCoursePoursuit re√ßu')
    StartCoursePoursuiteGame(data)
end)

-- Arr√™ter le jeu
RegisterNetEvent('scharman:client:stopCoursePoursuit', function()
    Config.DebugPrint('√âv√©nement stopCoursePoursuit re√ßu')
    StopCoursePoursuiteGame()
end)

-- Notification
RegisterNetEvent('scharman:client:courseNotification', function(message, duration, notifType)
    ShowGameNotification(message, duration or 3000, notifType or 'info')
end)

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- COMMANDES DEBUG
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- Commande pour quitter la partie en cours
RegisterCommand('quit_course', function()
    if inGame then
        Config.InfoPrint('Commande /quit_course utilis√©e')
        StopCoursePoursuiteGame()
        TriggerServerEvent('scharman:server:coursePoursuiteLeft', instanceId)
        ShowGameNotification('‚úÖ Vous avez quitt√© la partie', 3000, 'success')
    else
        ShowGameNotification('‚ùå Vous n\'√™tes pas en partie', 3000, 'error')
    end
end, false)

if Config.Debug then
    RegisterCommand('course_stop', function()
        if inGame then
            StopCoursePoursuiteGame()
            TriggerServerEvent('scharman:server:coursePoursuiteLeft', instanceId)
            Config.InfoPrint('Course arr√™t√©e manuellement')
        else
            Config.ErrorPrint('Tu n\'es pas en jeu')
        end
    end, false)
    
    RegisterCommand('course_info', function()
        print('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
        print('√âtat du jeu: ' .. (inGame and 'EN JEU' or 'PAS EN JEU'))
        print('Instance: ' .. (instanceId or 'Aucune'))
        print('V√©hicule: ' .. (currentVehicle or 'Aucun'))
        print('V√©hicule existe: ' .. tostring(DoesEntityExist(currentVehicle)))
        print('Bot PED: ' .. (botPed or 'Aucun'))
        print('Bot V√©hicule: ' .. (botVehicle or 'Aucun'))
        
        local ped = PlayerPedId()
        local veh = GetVehiclePedIsIn(ped, false)
        print('Joueur dans v√©hicule: ' .. tostring(veh))
        print('Joueur dans currentVehicle: ' .. tostring(veh == currentVehicle))
        
        if gameEndTime then
            local timeLeft = gameEndTime - GetGameTimer()
            print('Temps restant: ' .. math.floor(timeLeft / 1000) .. 's')
        end
        print('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
    end, false)
    
    Config.InfoPrint('Commandes de debug Course Poursuite disponibles')
    Config.InfoPrint('- /quit_course : Quitter la partie en cours')
    Config.InfoPrint('- /course_stop : Arr√™ter le jeu')
    Config.InfoPrint('- /course_info : Afficher les informations')
end

Config.DebugPrint('Fichier client/course_poursuite.lua charg√© avec succ√®s')
